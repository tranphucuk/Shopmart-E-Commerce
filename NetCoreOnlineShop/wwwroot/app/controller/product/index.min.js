var product={init:function(){this.loadCategory();this.registerEvents();this.loadData();this.loadCkEditor()},registerEvents:function(){var n=$("#frmProduct").validate({errorClass:"red",rules:{productName:"required",ddlCategory:"required",loadFileExcel:{required:!0,extension:"xlsx|xls|csv"},price:{required:!0,number:!0,min:0},promotionPrice:{number:!0,min:0},originalPrice:{required:!0,number:!0,min:0},productDescription:"required",productContent:"required",Unit:{required:!0,number:!0,min:0},productTag:"required",productImage:"required"},messages:{price:{required:"Price must has value",number:"Price must be a number",min:"Price must be a positive number"},promotionPrice:{required:"Promotion Price must has value",number:"Promotion Price must be a number",min:"Promotion Price must be a positive number"},originalPrice:{required:"Original Price must has value",number:"Original Price must be a number",min:"Original Price must be a positive number"},productName:{required:"Product name is required"},productContent:{required:"Content is required"},ddlCategory:{required:"Chooese a category"},productDescription:{required:"Product description is required"},productTag:{required:"Product tags is required"},productImage:{required:"Product image is required"},Unit:{required:"Product tags is required",number:"Unit must be a number",min:"unit must be equal or greater than 0"}},showErrors:function(t,i){if(n.submitted){var r="";$.each(i,function(){r+="* "+this.message+"\n"});common.notify(r,"warn");submitted=!1}}});$("#ddlShowPage").on("change",function(){common.config.pageSize=$("#ddlShowPage :selected").text();common.config.pageIndex=1;$("#paginationUL").twbsPagination("destroy");product.loadData()});$("#btnSearch").on("click",function(){$("#paginationUL").twbsPagination("destroy");$("#ddlShowPage").prop("selectedIndex",0);common.config.pageIndex=1;common.config.pageSize=10;product.loadData()});$("#txtKeyword").on("keypress",function(n){n.which===13&&$("#btnSearch").click()});$("#btnCreate").off("click").on("click",function(){product.loadParent();$("#add_edit_Product").modal("show");product.clearForm();n.resetForm()});$("#btn-save-product").on("click",function(){if(n.form()){var t={};$("#hidProductId").val()!=0&&(t.Id=$("#hidProductId").val(),t.CreatedDate=$("#txtCreatedDate").val());t.Name=$("#txtProductName").val();t.CategoryId=$("#ddlproductCategory").val();t.Price=$("#txtProductPrice").val();t.PromotionPrice=$("#txtPromotionPrice").val();t.OriginalPrice=$("#txtOriginalPrice").val();t.Image=$("#txtProductImg").val();t.Description=$("#txtProductDescription").val();t.Content=CKEDITOR.instances.txtProductContent.getData();t.Unit=$("#txtProductUnit").val();t.ViewCount=$("#txtProductViewCount").val();t.Tags=$("#txtProductTag").val();t.Status=$("#ckStatus").is(":checked")?1:0;t.HomeFlag=$("#ckShowHome").is(":checked")?1:0;t.HotFlag=$("#ckHotProduct").is(":checked")?1:0;$.ajax({type:"POST",url:"/Admin/Product/SaveProduct",data:{productVm:t},beforeSend:common.runLoadingIndicator(),success:function(n){$("#add_edit_Product").modal("hide");product.loadData(!0);n.HttpType=="update"?common.notify("Updated product: "+n.ObjReturn.Name,"success"):common.notify("Created success product: "+n.ObjReturn.Name,"success");common.stopLoadingIndicator()},error:function(){common.notify("An error has occurred");common.stopLoadingIndicator()}})}});$("body").on("click",".btnUpdateProduct",function(){var n=$(this).attr("data-id");$.ajax({type:"GET",url:"/Admin/Product/GetProductDetail",data:{id:n},dataType:"json",beforeSend:common.runLoadingIndicator(),success:function(n){$("#add_edit_Product").modal("show");$("#hidProductId").val(n.Id);$("#txtProductName").val(n.Name);product.loadParent(n.CategoryId);$("#txtProductPrice").val(n.Price);$("#txtPromotionPrice").val(n.PromotionPrice);$("#txtOriginalPrice").val(n.OriginalPrice);$("#txtProductImg").val(n.Image);$("#txtProductDescription").val(n.Description);CKEDITOR.instances.txtProductContent.setData(n.Content);$("#txtProductUnit").val(n.Unit);$("#txtProductViewCount").val(n.ViewCount);$("#txtProductTag").val(n.Tags);$("#frmCreatedDate").show();$("#frmModifiedDate").show();$("#txtModifiedDate").val(common.formatDateTime(n.ModifiedDate));$("#txtCreatedDate").val(common.formatDateTime(n.CreatedDate));$("#ckStatus").prop("checked",n.Status);$("#ckShowHome").prop("checked",n.HomeFlag);$("#ckHotProduct").prop("checked",n.HotFlag);common.stopLoadingIndicator()},error:function(n){common.notify("Error loading product detail.","error");console.log(n);common.stopLoadingIndicator()}})});$("body").on("click",".btnDeleteProduct",function(n){n.preventDefault();var t=$(this).attr("data-id");common.confirm("Are you sure to delete?",function(){$.ajax({url:"/Admin/Product/Delete",type:"POST",data:{id:t},beforeSend:common.runLoadingIndicator(),success:function(){common.notify("Deleted success","success");product.loadData(!0);common.stopLoadingIndicator()},error:function(n){common.notify("An error has occurred. Please check console tab","error");product.loadData(!0);console.log(n);common.stopLoadingIndicator()}})})});$("body").on("click","#checkAll",function(){var n=$("#checkAll").is(":checked");$('#tbl-content input[type="checkbox"]').prop("checked",n)});$("body").on("click",".check-product-single",function(){var n=$('#tbl-content input[type="checkbox"]').length,t=$('#tbl-content input[type="checkbox"]:checked').length;t===n?$("#checkAll").prop("checked",!0):$("#checkAll").prop("checked",!1)});$("#btnSelectImg").off("click").on("click",function(){$("#fileProductImage").click()});$("#fileProductImage").on("change",function(){var n={FileSize:this.files[0].size,FileName:this.files[0].name};common.readImg(this.files[0],function(t){n.ImgValueBase64=t.target.result;$.ajax({type:"POST",url:"/Admin/Upload/UploadImage",data:{imageVm:n},success:function(n){$("#txtProductImg").val(n.ImgPath);common.notify('Saved an image name: "  '+n.FileName+'  " to root folder',"success")},error:function(n){common.notify("An error has occurred, please check console","error");console.log(n)}})})});$("#btnDeleteMulti").off("click").on("click",function(){var n=[];$(".check-product-single:checked").each(function(){n.push($(this).attr("data-id"))});common.confirm("Are you sure to delete "+n.length+" products?",function(){$.ajax({type:"POST",url:"/Admin/Product/DeleteMulti",data:{ids:JSON.stringify(n)},dataType:"json",success:function(n){common.notify("Deleted success "+n.length+" products","success");product.loadData(!0)},error:function(){common.notify("Incorrect formart product details","error");product.loadData(!0);console.log(err)}})})});$("#btnExcelProduct").off("click").on("click",function(){product.loadParentExcel()});$("#btnSaveExcel").off("click").on("click",function(){var t=$("#producstExcelFile")[0].files[0],n=new FormData;n.append("files",t);n.append("categoryId",$("#ddlLoadCategory").val());$.ajax({type:"POST",url:"/Admin/Product/ImportExcel",data:n,processData:!1,contentType:!1,success:function(n){common.notify("Imported success "+n+" new products","success");$("#import_excel_product").modal("hide");product.loadData(!0)},error:function(n){common.notify("Incorrect format product details","error");product.loadData(!0);console.log(n)}})});$("#btn-save-Products").on("click",function(){$.ajax({type:"POST",url:"/Admin/Product/ExportExcel",beforeSend:common.runLoadingIndicator(),success:function(n){window.location.href=n;common.stopLoadingIndicator()},error:function(n){common.notify("Error: "+n,"error");common.stopLoadingIndicator()}})});$("body").on("click",".btnProductOption",function(n){n.preventDefault();$.contextMenu({selector:".btnProductOption",trigger:"left",callback:function(n){var t=$(this).attr("data-id");$("#productId").val(t);switch(n){case"Quantity":quantity.loadData(t);break;case"Price":price.loadData(t);break;case"Image":image.loadData(t)}},items:{Quantity:{name:"Quantity",icon:"fa-tasks"},Price:{name:"Price",icon:"fa-money"},Image:{name:"Images",icon:"fa-picture-o"},sep1:"---------",quit:{name:"Quit",icon:"context-menu-icon context-menu-icon-quit"}}})})},category:[],errors:"",loadParentExcel:function(){var n=common.unflattern(product.category);$("#ddlLoadCategory").combotree({data:n});$("#import_excel_product").modal("show")},loadCkEditor:function(){CKEDITOR.replace("productContent",{language:"en",width:"765px"});$.fn.modal.Constructor.prototype.enforceFocus=function(){$(document).off("focusin.bs.modal").on("focusin.bs.modal",$.proxy(function(n){this.$element[0]===n.target||this.$element.has(n.target).length||$(n.target).closest(".cke_dialog, .cke").length||this.$element.trigger("focus")},this))}},clearForm:function(){$("#hidProductId").val(0);$("#txtProductName").val("");$("#ddlproductCategory").val("");$("#txtProductPrice").val(0);$("#txtPromotionPrice").val(0);$("#txtOriginalPrice").val(0);$("#txtProductImg").val("");$("#txtProductDescription").val("");CKEDITOR.instances.txtProductContent.setData("");$("#txtProductUnit").val("0");$("#txtProductViewCount").val(0);$("#txtProductTag").val("");$("#frmCreatedDate").hide();$("#frmModifiedDate").hide();$("#ckStatus").prop("checked",!0);$("#ckShowHome").prop("checked",!1);$("#ckHotProduct").prop("checked",!1)},loadParent:function(n){var t=common.unflattern(product.category);$("#ddlproductCategory").combotree({data:t});$("#ddlCategory").combotree({data:t});n!=null&&$("#ddlproductCategory").combotree("setValue",n)},loadCategory:function(){$.ajax({url:"/Admin/Product/GetAllCategories",type:"GET",dataType:"json",success:function(n){$.each(n,function(n,t){product.category.push({id:t.Id,text:t.Name,parentId:t.ParentId,sortOrder:t.SortOrder})});product.loadParent()},error:function(n){common.notify("Error loading category","error");console.log(n)}})},loadData:function(){var t=$("#table-template").html(),n="";$.ajax({type:"GET",url:"/Admin/Product/GetAllPaging",data:{categoryId:$("#ddlCategory").val(),keyword:$("#txtKeyword").val(),page:common.config.pageIndex,pageSize:common.config.pageSize},beforeSend:common.runLoadingIndicator(),dataType:"json",success:function(i){console.log(i);$.each(i.Results,function(i,r){n+=Mustache.render(t,{Id:r.Id,Name:r.Name,Category:r.ProductCategory.Name,Price:common.formartNumber(r.Price,"0,0"),Image:common.formatImage(r.Image,r.Name),CreatedDate:common.formatDateTime(r.CreatedDate),Status:common.getStatusLabel(r.Status)})});$("#lblTotalRecords").text(i.RowCount);$("#tbl-content").html(n);product.config();i.RowCount>0&&product.wrapPaging(i.RowCount);common.stopLoadingIndicator()},error:function(n){console.log(n);common.notify("Error loading data","error");common.stopLoadingIndicator()}})},config:function(){$("#checkAll").prop("checked",!1)},wrapPaging:function(n){var t=Math.ceil(n/common.config.pageSize);$("#paginationUL").twbsPagination({totalPages:t,visiblePages:7,onPageClick:function(n,t){common.config.pageIndex!==t&&(common.config.pageIndex=t,product.loadData())}})}};product.init();